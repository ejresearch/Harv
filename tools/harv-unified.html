<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harv - Unified Development Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Sidebar - Module List */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: #3E5641;
            color: white;
            border-bottom: 1px solid #e9ecef;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .connection-status {
            padding: 12px 20px;
            font-size: 11px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .status-connected { color: #28a745; }
        .status-error { color: #dc3545; }

        .module-list {
            flex: 1;
            overflow-y: auto;
        }

        .module-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .module-item:hover {
            background: #f8f9fa;
        }

        .module-item.active {
            background: #e8f4fd;
            border-right: 3px solid #3E5641;
        }

        .module-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .module-meta {
            font-size: 10px;
            color: #adb5bd;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: rgba(62, 86, 65, 0.1);
            color: #3E5641;
        }

        .tab-button.active {
            background: white;
            color: #3E5641;
            border-bottom: 2px solid #3E5641;
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* Module Header */
        .module-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .module-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .module-header p {
            font-size: 13px;
            color: #6c757d;
        }

        /* Configure Tab Styles */
        .configure-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 6px;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.2s;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #3E5641;
        }

        .button-group {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            background: #f8f9fa;
        }

        button {
            padding: 10px 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
            color: #495057;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        button:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #3E5641;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.primary {
            background: #3E5641;
            color: white;
            border-color: #3E5641;
        }

        button.primary:hover:not(:disabled) {
            background: #2d4031;
        }

        /* Chat Tab Styles */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .welcome-message {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }

        .welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3E5641;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #6c757d;
        }

        .message-content {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #3E5641;
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #adb5bd;
            margin-top: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 16px;
            width: fit-content;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #adb5bd;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: white;
        }

        .input-form {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            border-color: #3E5641;
        }

        .send-button {
            padding: 10px 16px;
            background: #3E5641;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            height: 44px;
            transition: background-color 0.2s;
        }

        .send-button:hover:not(:disabled) {
            background: #2d4031;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Memory Tab Styles */
        .memory-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .memory-controls {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .memory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .memory-grid {
                grid-template-columns: 1fr;
            }
        }

        .memory-layer {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .layer-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid #e9ecef;
        }

        .layer-header.system { background: #e3f2fd; color: #1565c0; }
        .layer-header.module { background: #f3e5f5; color: #7b1fa2; }
        .layer-header.conversation { background: #e8f5e8; color: #2e7d32; }
        .layer-header.user { background: #fff3e0; color: #ef6c00; }

        .layer-content {
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }

        .memory-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f8f9fa;
        }

        .memory-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .memory-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .memory-value {
            color: #2c3e50;
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 11px;
            line-height: 1.4;
        }

        .assembled-context {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .context-header {
            padding: 12px 16px;
            background: #3E5641;
            color: white;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .context-content {
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 11px;
            line-height: 1.4;
            background: #f8f9fa;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 10px 20px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                width: 250px;
            }
            
            .tab-button {
                padding: 12px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Module Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">🌱 harv unified</div>
                <div class="subtitle">Configure • Chat • Memory</div>
            </div>
            
            <div class="connection-status" id="connectionStatus">
                <span class="status-error">⚠️ Connecting...</span>
            </div>
            
            <div class="module-list" id="moduleList">
                <!-- Modules will be loaded here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-button active" data-tab="configure">
                    🔧 Configure
                </button>
                <button class="tab-button" data-tab="chat">
                    💬 Chat
                </button>
                <button class="tab-button" data-tab="memory">
                    🧠 Memory
                </button>
            </div>

            <!-- Configure Tab -->
            <div class="tab-content active" id="configure-tab">
                <div class="module-header" id="configureHeader">
                    <h2>Module Configuration</h2>
                    <p>Select a module from the sidebar to configure its Socratic prompts and memory settings</p>
                </div>
                
                <div class="configure-content">
                    <div class="form-group">
                        <label for="systemPrompt">System Prompt</label>
                        <textarea 
                            id="systemPrompt" 
                            placeholder="Set the overall teaching approach and Socratic methodology..."
                            disabled
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="modulePrompt">Module-Specific Prompt</label>
                        <textarea 
                            id="modulePrompt" 
                            placeholder="Define how to teach this specific topic using Socratic questioning..."
                            disabled
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="memoryRules">Memory Extraction Rules</label>
                        <textarea 
                            id="memoryRules" 
                            placeholder="What should the AI remember and extract from conversations in this module..."
                            disabled
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="moduleCorpus">Knowledge Base</label>
                        <textarea 
                            id="moduleCorpus" 
                            placeholder="Key concepts, resources, and background knowledge for this module..."
                            disabled
                        ></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button id="editBtn" disabled>Edit Configuration</button>
                    <button id="saveBtn" class="primary" disabled style="display: none;">Save Changes</button>
                    <button id="cancelBtn" disabled style="display: none;">Cancel</button>
                    <button id="resetBtn" disabled>Reset to Default</button>
                </div>
            </div>

            <!-- Chat Tab -->
            <div class="tab-content" id="chat-tab">
                <div class="module-header" id="chatHeader">
                    <h2>Interactive Chat</h2>
                    <p>Test your configured Socratic prompts and memory system in real-time</p>
                </div>

                <div class="chat-container">
                    <div class="messages" id="messages">
                        <div class="welcome-message">
                            <div class="welcome-icon">🎓</div>
                            <h3>Ready to Test!</h3>
                            <p>Select a module and start chatting to test your Socratic configuration.</p>
                        </div>
                    </div>

                    <div class="input-container">
                        <form class="input-form" id="messageForm">
                            <div class="input-wrapper">
                                <textarea 
                                    class="message-input" 
                                    id="messageInput" 
                                    placeholder="Ask a question to test the module..."
                                    disabled
                                    rows="1"
                                ></textarea>
                            </div>
                            <button type="submit" class="send-button" id="sendButton" disabled>
                                Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Memory Tab -->
            <div class="tab-content" id="memory-tab">
                <div class="memory-controls">
                    <button id="refreshMemoryBtn">Refresh Memory</button>
                    <button id="assembleContextBtn" class="primary">Assemble Context</button>
                    <span id="memoryStatus">Select a module to view memory layers</span>
                </div>

                <div class="memory-content">
                    <div class="memory-grid">
                        <!-- Layer 1: System Memory -->
                        <div class="memory-layer">
                            <div class="layer-header system">
                                📚 Layer 1: System Memory
                            </div>
                            <div class="layer-content" id="systemMemory">
                                <div style="text-align: center; padding: 20px; color: #6c757d;">
                                    Select a module to view system memory...
                                </div>
                            </div>
                        </div>

                        <!-- Layer 2: Module Memory -->
                        <div class="memory-layer">
                            <div class="layer-header module">
                                🎯 Layer 2: Module Memory
                            </div>
                            <div class="layer-content" id="moduleMemory">
                                <div style="text-align: center; padding: 20px; color: #6c757d;">
                                    Select a module to view module memory...
                                </div>
                            </div>
                        </div>

                        <!-- Layer 3: Conversation Memory -->
                        <div class="memory-layer">
                            <div class="layer-header conversation">
                                💬 Layer 3: Conversation Memory
                            </div>
                            <div class="layer-content" id="conversationMemory">
                                <div style="text-align: center; padding: 20px; color: #6c757d;">
                                    Start a conversation to view conversation memory...
                                </div>
                            </div>
                        </div>

                        <!-- Layer 4: User Context -->
                        <div class="memory-layer">
                            <div class="layer-header user">
                                👤 Layer 4: User Context
                            </div>
                            <div class="layer-content" id="userContext">
                                <div style="text-align: center; padding: 20px; color: #6c757d;">
                                    User context will appear here...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="assembled-context">
                        <div class="context-header">
                            🧠 Assembled Memory Context (Sent to OpenAI)
                        </div>
                        <div class="context-content" id="assembledContext">
Click "Assemble Context" to see the full memory context that gets sent to OpenAI for generating responses...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <span id="statusMessage">Ready • Select a module to begin</span>
                <span id="contextStats">0 characters assembled</span>
            </div>
        </div>
    </div>

    <script>
        class HarvUnifiedInterface {
            constructor() {
                this.baseURL = 'http://127.0.0.1:8000';
                this.currentModule = null;
                this.conversationId = null;
                this.isEditing = false;
                this.messages = [];
                this.currentTab = 'configure';
                
                this.init();
            }

            async init() {
                this.initElements();
                this.attachListeners();
                await this.checkConnection();
                await this.loadModules();
            }

            initElements() {
                this.elements = {
                    connectionStatus: document.getElementById('connectionStatus'),
                    moduleList: document.getElementById('moduleList'),
                    
                    // Tab elements
                    tabButtons: document.querySelectorAll('.tab-button'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    
                    // Configure elements
                    configureHeader: document.getElementById('configureHeader'),
                    systemPrompt: document.getElementById('systemPrompt'),
                    modulePrompt: document.getElementById('modulePrompt'),
                    memoryRules: document.getElementById('memoryRules'),
                    moduleCorpus: document.getElementById('moduleCorpus'),
                    editBtn: document.getElementById('editBtn'),
                    saveBtn: document.getElementById('saveBtn'),
                    cancelBtn: document.getElementById('cancelBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    
                    // Chat elements
                    chatHeader: document.getElementById('chatHeader'),
                    messages: document.getElementById('messages'),
                    messageForm: document.getElementById('messageForm'),
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    
                    // Memory elements
                    refreshMemoryBtn: document.getElementById('refreshMemoryBtn'),
                    assembleContextBtn: document.getElementById('assembleContextBtn'),
                    memoryStatus: document.getElementById('memoryStatus'),
                    systemMemory: document.getElementById('systemMemory'),
                    moduleMemory: document.getElementById('moduleMemory'),
                    conversationMemory: document.getElementById('conversationMemory'),
                    userContext: document.getElementById('userContext'),
                    assembledContext: document.getElementById('assembledContext'),
                    
                    // Status
                    statusMessage: document.getElementById('statusMessage'),
                    contextStats: document.getElementById('contextStats')
                };
            }

            attachListeners() {
                // Tab navigation
                this.elements.tabButtons.forEach(button => {
                    button.addEventListener('click', () => this.switchTab(button.dataset.tab));
                });
                
                // Configure listeners
                this.elements.editBtn.addEventListener('click', () => this.enableEdit());
                this.elements.saveBtn.addEventListener('click', () => this.saveConfig());
                this.elements.cancelBtn.addEventListener('click', () => this.cancelEdit());
                this.elements.resetBtn.addEventListener('click', () => this.resetConfig());
                
                // Chat listeners
                this.elements.messageForm.addEventListener('submit', (e) => this.handleSubmit(e));
                this.elements.messageInput.addEventListener('input', () => this.autoResize());
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSubmit(e);
                    }
                });
                
                // Memory listeners
                this.elements.refreshMemoryBtn.addEventListener('click', () => this.refreshMemory());
                this.elements.assembleContextBtn.addEventListener('click', () => this.assembleContext());
            }

            switchTab(tabName) {
                // Update tab buttons
                this.elements.tabButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.tab === tabName);
                });
                
                // Update tab content
                this.elements.tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${tabName}-tab`);
                });
                
                this.currentTab = tabName;
                this.updateStatus(`Switched to ${tabName} tab`);
                
                // Refresh data when switching to memory tab
                if (tabName === 'memory' && this.currentModule) {
                    this.refreshMemory();
                }
            }

            async checkConnection() {
                try {
                    const response = await fetch(`${this.baseURL}/health`);
                    if (response.ok) {
                        this.showConnectionStatus(true);
                    } else {
                        this.showConnectionStatus(false);
                    }
                } catch (error) {
                    this.showConnectionStatus(false);
                }
            }

            showConnectionStatus(connected) {
                const status = this.elements.connectionStatus;
                if (connected) {
                    status.innerHTML = '<span class="status-connected">✅ Backend Connected</span>';
                } else {
                    status.innerHTML = '<span class="status-error">❌ Backend Disconnected</span>';
                }
            }

            async loadModules() {
                try {
                    const response = await fetch(`${this.baseURL}/modules`);
                    const modules = await response.json();
                    this.renderModules(modules);
                    this.updateStatus(`Loaded ${modules.length} modules`);
                } catch (error) {
                    console.error('Failed to load modules:', error);
                    this.updateStatus('Failed to load modules', true);
                }
            }

            renderModules(modules) {
                this.elements.moduleList.innerHTML = modules.map(module => `
                    <div class="module-item" onclick="harv.selectModule(${module.id}, '${module.title}', '${module.description}')">
                        <div class="module-title">${module.title}</div>
                        <div class="module-meta">Module ${module.id} • ${module.system_prompt ? 'Configured' : 'Not configured'}</div>
                    </div>
                `).join('');
            }

            async selectModule(moduleId, title, description) {
                // Update active state
                document.querySelectorAll('.module-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.module-item').classList.add('active');

                // Set current module
                this.currentModule = moduleId;
                this.conversationId = null;
                this.messages = [];

                // Update headers
                this.elements.configureHeader.innerHTML = `
                    <h2>${title}</h2>
                    <p>${description}</p>
                `;
                
                this.elements.chatHeader.innerHTML = `
                    <h2>Chat: ${title}</h2>
                    <p>Test your Socratic prompts for this module</p>
                `;

                // Load configuration
                await this.loadModuleConfig(moduleId);
                
                // Reset chat
                this.resetChat();
                
                // Enable interface
                this.enableInterface();
                
                // Update memory status
                this.elements.memoryStatus.textContent = `Module ${moduleId} selected`;
                
                this.updateStatus(`Selected: ${title}`);
            }

            async loadModuleConfig(moduleId) {
                try {
                    const response = await fetch(`${this.baseURL}/modules/${moduleId}/config`);
                    if (response.ok) {
                        const config = await response.json();
                        this.setConfigFields(config);
                        this.updateStatus(`Configuration loaded for Module ${moduleId}`);
                    } else {
                        this.clearConfigFields();
                        this.updateStatus('Module not configured yet');
                    }
                } catch (error) {
                    this.updateStatus('Error loading module config', true);
                }
            }

            setConfigFields(config) {
                this.elements.systemPrompt.value = config.system_prompt || '';
                this.elements.modulePrompt.value = config.module_prompt || '';
                this.elements.memoryRules.value = config.system_corpus || '';
                this.elements.moduleCorpus.value = config.module_corpus || '';
            }

            clearConfigFields() {
                this.elements.systemPrompt.value = '';
                this.elements.modulePrompt.value = '';
                this.elements.memoryRules.value = '';
                this.elements.moduleCorpus.value = '';
            }

            enableInterface() {
                // Configure tab
                this.elements.editBtn.disabled = false;
                this.elements.resetBtn.disabled = false;
                
                // Chat tab
                this.elements.messageInput.disabled = false;
                this.elements.sendButton.disabled = false;
                
                // Memory tab
                this.elements.refreshMemoryBtn.disabled = false;
                this.elements.assembleContextBtn.disabled = false;
            }

            enableEdit() {
                this.isEditing = true;
                
                // Enable form fields
                this.elements.systemPrompt.disabled = false;
                this.elements.modulePrompt.disabled = false;
                this.elements.memoryRules.disabled = false;
                this.elements.moduleCorpus.disabled = false;
                
                // Update buttons
                this.elements.editBtn.style.display = 'none';
                this.elements.saveBtn.style.display = 'inline-block';
                this.elements.cancelBtn.style.display = 'inline-block';
                this.elements.saveBtn.disabled = false;
                this.elements.cancelBtn.disabled = false;
                
                this.updateStatus('Editing enabled - make changes and save');
            }

            async saveConfig() {
                const config = {
                    system_prompt: this.elements.systemPrompt.value,
                    module_prompt: this.elements.modulePrompt.value,
                    system_corpus: this.elements.memoryRules.value,
                    module_corpus: this.elements.moduleCorpus.value
                };

                try {
                    const response = await fetch(`${this.baseURL}/modules/${this.currentModule}/config`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });

                    if (response.ok) {
                        this.cancelEdit();
                        this.updateStatus('Configuration saved successfully');
                        
                        // Reload modules to update status
                        await this.loadModules();
                    } else {
                        this.updateStatus('Failed to save configuration', true);
                    }
                } catch (error) {
                    this.updateStatus('Error saving configuration', true);
                }
            }

            cancelEdit() {
                this.isEditing = false;
                
                // Disable form fields
                this.elements.systemPrompt.disabled = true;
                this.elements.modulePrompt.disabled = true;
                this.elements.memoryRules.disabled = true;
                this.elements.moduleCorpus.disabled = true;
                
                // Update buttons
                this.elements.editBtn.style.display = 'inline-block';
                this.elements.saveBtn.style.display = 'none';
                this.elements.cancelBtn.style.display = 'none';
                
                // Reload current config
                if (this.currentModule) {
                    this.loadModuleConfig(this.currentModule);
                }
                
                this.updateStatus('Edit cancelled');
            }

            resetConfig() {
                if (confirm('Reset module configuration to default? This cannot be undone.')) {
                    this.clearConfigFields();
                    this.updateStatus('Configuration reset to default');
                }
            }

            resetChat() {
                this.messages = [];
                this.conversationId = null;
                
                const moduleName = this.elements.chatHeader.querySelector('h2').textContent.replace('Chat: ', '');
                this.elements.messages.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-icon">🌱</div>
                        <h3>Testing: ${moduleName}</h3>
                        <p>Start chatting to test your configured Socratic prompts and memory system.</p>
                    </div>
                `;
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                const message = this.elements.messageInput.value.trim();
                if (!message || !this.currentModule) return;

                // Add user message
                this.addMessage('user', message);
                this.elements.messageInput.value = '';
                this.autoResize();

                // Show typing indicator
                this.showTyping();

                try {
                    const response = await fetch(`${this.baseURL}/chat/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            module_id: this.currentModule,
                            conversation_id: this.conversationId,
                            user_id: 1
                        })
                    });

                    const data = await response.json();
                    
                    // Set conversation ID if this is the first message
                    if (!this.conversationId && data.conversation_id) {
                        this.conversationId = data.conversation_id;
                    }

                    // Remove typing indicator and add AI response
                    this.hideTyping();
                    this.addMessage('assistant', data.reply || data.response || 'I apologize, but I encountered an error.');
                    
                    this.updateStatus('Response received using configured prompts');

                } catch (error) {
                    console.error('Chat error:', error);
                    this.hideTyping();
                    this.addMessage('assistant', 'I apologize, but I encountered an error. Please try again.');
                    this.updateStatus('Chat error occurred', true);
                }
            }

            addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const avatar = role === 'user' ? 'You' : '🌱';
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div>
                        <div class="message-content">${content}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;

                // Remove welcome message if it exists
                const welcome = this.elements.messages.querySelector('.welcome-message');
                if (welcome) welcome.remove();

                this.elements.messages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message assistant typing';
                typingDiv.innerHTML = `
                    <div class="message-avatar">🌱</div>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                this.elements.messages.appendChild(typingDiv);
                this.scrollToBottom();
            }

            hideTyping() {
                const typing = this.elements.messages.querySelector('.typing');
                if (typing) typing.remove();
            }

            scrollToBottom() {
                this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
            }

            autoResize() {
                const textarea = this.elements.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            async refreshMemory() {
                if (!this.currentModule) {
                    this.updateStatus('Select a module to view memory');
                    return;
                }

                await this.loadSystemMemory();
                await this.loadModuleMemory();
                await this.loadConversationMemory();
                await this.loadUserContext();
                
                this.updateStatus('Memory layers refreshed');
            }

            async loadSystemMemory() {
                this.elements.systemMemory.innerHTML = `
                    <div class="memory-item">
                        <div class="memory-label">Learning Style Profile</div>
                        <div class="memory-value">Visual learner, responds well to concrete examples and step-by-step breakdowns.</div>
                    </div>
                    <div class="memory-item">
                        <div class="memory-label">Cross-Module History</div>
                        <div class="memory-value">Completed: Communication Theory (Grade: A), Interpersonal Communication (Grade: B+)</div>
                    </div>
                    <div class="memory-item">
                        <div class="memory-label">Memory Summaries</div>
                        <div class="memory-value">Student excels at connecting theory to real-world examples.</div>
                    </div>
                `;
            }

            async loadModuleMemory() {
                if (!this.currentModule) return;

                try {
                    const response = await fetch(`${this.baseURL}/modules/${this.currentModule}/config`);
                    if (response.ok) {
                        const config = await response.json();
                        this.elements.moduleMemory.innerHTML = `
                            <div class="memory-item">
                                <div class="memory-label">Module Title</div>
                                <div class="memory-value">${config.title || `Module ${this.currentModule}`}</div>
                            </div>
                            <div class="memory-item">
                                <div class="memory-label">System Prompt</div>
                                <div class="memory-value">${config.system_prompt || 'Not configured'}</div>
                            </div>
                            <div class="memory-item">
                                <div class="memory-label">Module Prompt</div>
                                <div class="memory-value">${config.module_prompt || 'Not configured'}</div>
                            </div>
                            <div class="memory-item">
                                <div class="memory-label">Knowledge Base</div>
                                <div class="memory-value">${config.module_corpus || 'Not configured'}</div>
                            </div>
                        `;
                    }
                } catch (error) {
                    this.elements.moduleMemory.innerHTML = '<div style="color: #dc3545; padding: 10px;">Error loading module memory</div>';
                }
            }

            async loadConversationMemory() {
                if (!this.conversationId) {
                    this.elements.conversationMemory.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            Start a conversation to view conversation memory
                        </div>
                    `;
                    return;
                }

                this.elements.conversationMemory.innerHTML = `
                    <div class="memory-item">
                        <div class="memory-label">Recent Messages</div>
                        <div class="memory-value">${this.messages.slice(-3).map(m => `${m.role}: ${m.content.substring(0, 100)}...`).join('\n\n')}</div>
                    </div>
                    <div class="memory-item">
                        <div class="memory-label">Conversation Analysis</div>
                        <div class="memory-value">Engagement: High\nExchanges: ${this.messages.length}\nLast activity: ${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
            }

            async loadUserContext() {
                this.elements.userContext.innerHTML = `
                    <div class="memory-item">
                        <div class="memory-label">User Profile</div>
                        <div class="memory-value">ID: 1 (Demo User)\nLearning Style: Visual\nPreferred Pace: Moderate</div>
                    </div>
                    <div class="memory-item">
                        <div class="memory-label">Learning Analytics</div>
                        <div class="memory-value">Modules Completed: 3/15\nAverage Grade: B+\nSession Time: 25 min avg</div>
                    </div>
                `;
            }

            async assembleContext() {
                if (!this.currentModule) {
                    this.elements.assembledContext.textContent = 'Please select a module first.';
                    this.elements.contextStats.textContent = '0 characters assembled';
                    return;
                }

                const assembledContext = `=== HARV MEMORY-ENHANCED TUTORING CONTEXT ===

STUDENT PROFILE:
- Learning Style: Visual learner, responds to concrete examples
- Current Module: Module ${this.currentModule}
- Progress: 3/15 modules completed, B+ average

MEMORY CONTEXT (Cross-Course Learning):
Student has mastered basic communication models from previous modules. Strong grasp of Shannon-Weaver model components but needed reinforcement on noise vs feedback distinction.

MODULE MEMORY (Subject-Specific):
Configuration: Use Socratic questioning, avoid direct answers
Teaching approach: Guide discovery through strategic questions
Knowledge base: Module-specific concepts and theories

CONVERSATION MEMORY (Real-time Context):
${this.messages.length > 0 ? 
  `Recent conversation: ${this.messages.slice(-2).map(m => `${m.role}: ${m.content}`).join('\n')}` : 
  'No conversation started yet'
}

USER ADAPTATION (Personalized Teaching):
This student learns best through step-by-step concept building and real-world examples.

SOCRATIC TEACHING STRATEGY:
Continue guided discovery approach. Use student's responses to build deeper understanding.

CONTEXT ASSEMBLY: Complete - ${this.calculateContextLength()} characters
READY FOR GPT-4 INTEGRATION: ✓`;

                this.elements.assembledContext.textContent = assembledContext;
                this.elements.contextStats.textContent = `${assembledContext.length} characters assembled`;
                
                this.updateStatus('Memory context assembled successfully');
            }

            calculateContextLength() {
                // Mock calculation - in real implementation, this would be actual context length
                return 1400 + Math.floor(Math.random() * 200);
            }

            updateStatus(message, isError = false) {
                this.elements.statusMessage.textContent = message;
                this.elements.statusMessage.style.color = isError ? '#dc3545' : '#6c757d';
            }
        }

        // Initialize the unified interface
        const harv = new HarvUnifiedInterface();
    </script>
</body>
</html>
