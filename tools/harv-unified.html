<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harv - Enhanced Unified Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: #3E5641;
            color: white;
            border-bottom: 1px solid #e9ecef;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .connection-status {
            padding: 12px 20px;
            font-size: 11px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .status-connected { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-enhanced { color: #007bff; }

        .module-list {
            flex: 1;
            overflow-y: auto;
        }

        .module-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .module-item:hover {
            background: #f8f9fa;
        }

        .module-item.active {
            background: #e8f4fd;
            border-right: 3px solid #3E5641;
        }

        .module-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .module-meta {
            font-size: 10px;
            color: #adb5bd;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background: rgba(62, 86, 65, 0.1);
            color: #3E5641;
        }

        .tab-button.active {
            background: white;
            color: #3E5641;
            border-bottom: 2px solid #3E5641;
        }

        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        .module-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .module-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .module-header p {
            font-size: 13px;
            color: #6c757d;
        }

        .configure-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 6px;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.2s;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #3E5641;
        }

        .button-group {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            background: #f8f9fa;
        }

        button {
            padding: 10px 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
            color: #495057;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        button:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #3E5641;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.primary {
            background: #3E5641;
            color: white;
            border-color: #3E5641;
        }

        button.primary:hover:not(:disabled) {
            background: #2d4031;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .welcome-message {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }

        .welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3E5641;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #6c757d;
        }

        .message-content {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #3E5641;
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #adb5bd;
            margin-top: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 16px;
            width: fit-content;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #adb5bd;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: white;
        }

        .input-form {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            border-color: #3E5641;
        }

        .send-button {
            padding: 10px 16px;
            background: #3E5641;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            height: 44px;
            transition: background-color 0.2s;
        }

        .send-button:hover:not(:disabled) {
            background: #2d4031;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .memory-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .memory-controls {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .memory-section {
            margin-bottom: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .memory-section h3 {
            padding: 12px 16px;
            background: #f8f9fa;
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid #e9ecef;
        }

        .memory-details {
            padding: 16px;
        }

        .memory-details p {
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.4;
        }

        .memory-details p:last-child {
            margin-bottom: 0;
        }

        .memory-details strong {
            color: #3E5641;
        }

        .enhanced-memory-display {
            max-height: 600px;
            overflow-y: auto;
        }

        .memory-metrics-card {
            background: #e8f4fd;
            border: 2px solid #3E5641;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .memory-metrics-card h3 {
            color: #3E5641;
            margin-bottom: 10px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .metric label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
            color: #6c757d;
        }

        .metric .value {
            font-size: 18px;
            font-weight: 600;
            color: #3E5641;
        }

        .memory-distribution {
            display: flex;
            width: 100%;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .layer {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .layer.system { background: linear-gradient(45deg, #007bff, #0056b3); }
        .layer.module { background: linear-gradient(45deg, #28a745, #1e7e34); }
        .layer.conversation { background: linear-gradient(45deg, #ffc107, #e0a800); color: #000; }
        .layer.prior { background: linear-gradient(45deg, #dc3545, #bd2130); }

        .memory-layer {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #3E5641;
            border-radius: 0 6px 6px 0;
        }

        .memory-layer h4 {
            margin: 0 0 10px 0;
            color: #3E5641;
            font-size: 14px;
        }

        .layer-content p {
            margin: 5px 0;
            font-size: 13px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .indicator.active {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .indicator.inactive {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        .prompt-preview-card {
            background: #f1f3f4;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
        }

        .prompt-preview-card h3 {
            background: #3E5641;
            color: white;
            padding: 12px 16px;
            margin: 0;
            font-size: 14px;
        }

        .prompt-content {
            padding: 15px;
        }

        .prompt-content pre {
            margin: 0;
            white-space: pre-wrap;
            font-size: 11px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .prompt-content button {
            margin-top: 10px;
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .prompt-content button:hover {
            background: #0056b3;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 10px 20px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .enhanced-badge {
            background: linear-gradient(45deg, #007bff, #28a745);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">🌱 harv unified <span class="enhanced-badge">Enhanced</span></div>
                <div class="subtitle">Configure • Chat • Enhanced Memory</div>
            </div>
            
            <div class="connection-status" id="connectionStatus">
                <span class="status-error">⚠️ Connecting...</span>
            </div>
            
            <div class="module-list" id="moduleList">
                <!-- Modules will be loaded here -->
            </div>
        </div>

        <div class="main-content">
            <div class="tab-nav">
                <button class="tab-button active" data-tab="configure">🔧 Configure</button>
                <button class="tab-button" data-tab="chat">💬 Chat</button>
                <button class="tab-button" data-tab="memory">🧠 Memory</button>
            </div>

            <!-- Configure Tab -->
            <div class="tab-content active" id="configure-tab">
                <div class="module-header" id="configureHeader">
                    <h2>Module Configuration</h2>
                    <p>Select a module from the sidebar to configure its Socratic prompts and memory settings</p>
                </div>
                
                <div class="configure-content">
                    <div class="form-group">
                        <label for="systemPrompt">System Prompt - Socratic Teaching Approach</label>
                        <textarea id="systemPrompt" placeholder="Define the overall Socratic methodology for guiding students to discover communication theory principles through strategic questioning..." disabled></textarea>
                    </div>

                    <div class="form-group">
                        <label for="modulePrompt">Module-Specific Learning Objectives</label>
                        <textarea id="modulePrompt" placeholder="Specific learning objectives and key concepts for this communication media module using Socratic discovery methods..." disabled></textarea>
                    </div>

                    <div class="form-group">
                        <label for="memoryRules">Communication Theory Knowledge Base</label>
                        <textarea id="memoryRules" placeholder="Core communication theories, media effects research, and foundational concepts relevant to this module..." disabled></textarea>
                    </div>

                    <div class="form-group">
                        <label for="moduleCorpus">Current Examples & Applications</label>
                        <textarea id="moduleCorpus" placeholder="Contemporary examples, case studies, and real-world applications of communication theory for this module..." disabled></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button id="editBtn" disabled>Edit Configuration</button>
                    <button id="saveBtn" class="primary" disabled style="display: none;">Save Changes</button>
                    <button id="cancelBtn" disabled style="display: none;">Cancel</button>
                    <button id="resetBtn" disabled>Reset to Default</button>
                </div>
            </div>

            <!-- Chat Tab -->
            <div class="tab-content" id="chat-tab">
                <div class="module-header" id="chatHeader">
                    <h2>Interactive Chat</h2>
                    <p>Test your configured Socratic prompts and memory system in real-time</p>
                </div>

                <div class="chat-container">
                    <div class="messages" id="messages">
                        <div class="welcome-message">
                            <div class="welcome-icon">📚</div>
                            <h3>Communication Media & Society</h3>
                            <p>Select a module to explore media theory, technology, and cultural impact through Socratic dialogue.</p>
                        </div>
                    </div>

                    <div class="input-container">
                        <form class="input-form" id="messageForm">
                            <div class="input-wrapper">
                                <textarea class="message-input" id="messageInput" placeholder="Ask about communication theory, media effects, or how this medium shapes society..." disabled rows="1"></textarea>
                            </div>
                            <button type="submit" class="send-button" id="sendButton" disabled>Send</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Enhanced Memory Tab -->
            <div class="tab-content" id="memory-tab">
                <div class="memory-controls">
                    <button id="refreshMemoryBtn">🔄 Refresh Memory</button>
                    <button id="assembleContextBtn" class="primary">🧠 Load Enhanced Memory</button>
                    <span id="memoryStatus">Select a module to view enhanced memory layers</span>
                </div>

                <div class="memory-content" id="memory-content">
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🧠</div>
                        <h3>Enhanced Memory System</h3>
                        <p>Select a module to view the enhanced dynamic memory layers with real-time metrics.</p>
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <span id="statusMessage">Ready • Enhanced Memory System Active</span>
                <span id="contextStats2">Dynamic memory system with 4-layer architecture</span>
            </div>
        </div>
    </div>

    <script>
        class HarvEnhancedInterface {
            constructor() {
                this.baseURL = 'http://127.0.0.1:8000';
                this.currentModule = null;
                this.conversationId = null;
                this.isEditing = false;
                this.messages = [];
                this.currentTab = 'configure';
                this.currentMessage = '';
                
                this.init();
            }

            async init() {
                this.initElements();
                this.attachListeners();
                await this.checkConnection();
                await this.loadModules();
            }

            initElements() {
                this.elements = {
                    connectionStatus: document.getElementById('connectionStatus'),
                    moduleList: document.getElementById('moduleList'),
                    
                    tabButtons: document.querySelectorAll('.tab-button'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    
                    configureHeader: document.getElementById('configureHeader'),
                    systemPrompt: document.getElementById('systemPrompt'),
                    modulePrompt: document.getElementById('modulePrompt'),
                    memoryRules: document.getElementById('memoryRules'),
                    moduleCorpus: document.getElementById('moduleCorpus'),
                    editBtn: document.getElementById('editBtn'),
                    saveBtn: document.getElementById('saveBtn'),
                    cancelBtn: document.getElementById('cancelBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    
                    chatHeader: document.getElementById('chatHeader'),
                    messages: document.getElementById('messages'),
                    messageForm: document.getElementById('messageForm'),
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    
                    refreshMemoryBtn: document.getElementById('refreshMemoryBtn'),
                    assembleContextBtn: document.getElementById('assembleContextBtn'),
                    memoryStatus: document.getElementById('memoryStatus'),
                    memoryContent: document.getElementById('memory-content'),
                    
                    statusMessage: document.getElementById('statusMessage')
                };
            }

            attachListeners() {
                this.elements.tabButtons.forEach(button => {
                    button.addEventListener('click', () => this.switchTab(button.dataset.tab));
                });
                
                this.elements.editBtn.addEventListener('click', () => this.enableEdit());
                this.elements.saveBtn.addEventListener('click', () => this.saveConfig());
                this.elements.cancelBtn.addEventListener('click', () => this.cancelEdit());
                this.elements.resetBtn.addEventListener('click', () => this.resetConfig());
                
                this.elements.messageForm.addEventListener('submit', (e) => this.sendMessage(e));
                this.elements.messageInput.addEventListener('input', () => this.autoResize());
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage(e);
                    }
                });
                
                this.elements.refreshMemoryBtn.addEventListener('click', () => this.loadEnhancedMemoryMetrics());
                this.elements.assembleContextBtn.addEventListener('click', () => this.loadEnhancedMemoryMetrics());
            }

            switchTab(tabName) {
                this.elements.tabButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.tab === tabName);
                });
                
                this.elements.tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${tabName}-tab`);
                });
                
                this.currentTab = tabName;
                this.updateStatus(`Switched to ${tabName} tab`);
                
                if (tabName === 'memory' && this.currentModule) {
                    this.loadEnhancedMemoryMetrics();
                }
            }

            async checkConnection() {
                try {
                    const response = await fetch(`${this.baseURL}/health`);
                    if (response.ok) {
                        this.showConnectionStatus(true);
                    } else {
                        this.showConnectionStatus(false);
                    }
                } catch (error) {
                    this.showConnectionStatus(false);
                }
            }

            showConnectionStatus(connected) {
                const status = this.elements.connectionStatus;
                if (connected) {
                    status.innerHTML = '<span class="status-enhanced">✅ Enhanced Backend Connected</span>';
                } else {
                    status.innerHTML = '<span class="status-error">❌ Backend Disconnected</span>';
                }
            }

            async loadModules() {
                try {
                    const response = await fetch(`${this.baseURL}/modules`);
                    const modules = await response.json();
                    this.renderModules(modules);
                    this.updateStatus(`Loaded ${modules.length} modules with enhanced memory`);
                } catch (error) {
                    console.error('Failed to load modules:', error);
                    this.updateStatus('Failed to load modules', true);
                }
            }

            renderModules(modules) {
                // Use the actual modules from your database
                this.elements.moduleList.innerHTML = modules.map(module => `
                    <div class="module-item" onclick="harv.selectModule(${module.id}, '${module.title}', '${module.description}')">
                        <div class="module-title">${module.title}</div>
                        <div class="module-meta">Module ${module.id} • ${module.system_prompt ? 'Configured' : 'Needs setup'}</div>
                    </div>
                `).join('');
            }

            async selectModule(moduleId, title, description) {
                document.querySelectorAll('.module-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.module-item').classList.add('active');

                this.currentModule = moduleId;
                this.conversationId = null;
                this.messages = [];

                this.elements.configureHeader.innerHTML = `<h2>${title}</h2><p>${description}</p>`;
                this.elements.chatHeader.innerHTML = `<h2>Chat: ${title}</h2><p>Test enhanced memory system for this module</p>`;

                await this.loadModuleConfig(moduleId);
                this.resetChat();
                this.enableInterface();
                this.elements.memoryStatus.textContent = `Enhanced memory for Module ${moduleId} ready`;
                this.updateStatus(`Selected: ${title} - Enhanced memory active`);
            }

            async loadModuleConfig(moduleId) {
                try {
                    const response = await fetch(`${this.baseURL}/modules/${moduleId}/config`);
                    if (response.ok) {
                        const config = await response.json();
                        this.setConfigFields(config);
                        this.updateStatus(`Enhanced configuration loaded for Module ${moduleId}`);
                    } else {
                        this.clearConfigFields();
                        this.updateStatus('Module not configured yet');
                    }
                } catch (error) {
                    this.updateStatus('Error loading module config', true);
                }
            }

            setConfigFields(config) {
                this.elements.systemPrompt.value = config.system_prompt || '';
                this.elements.modulePrompt.value = config.module_prompt || '';
                this.elements.memoryRules.value = config.system_corpus || '';
                this.elements.moduleCorpus.value = config.module_corpus || '';
            }

            clearConfigFields() {
                this.elements.systemPrompt.value = '';
                this.elements.modulePrompt.value = '';
                this.elements.memoryRules.value = '';
                this.elements.moduleCorpus.value = '';
            }

            enableInterface() {
                this.elements.editBtn.disabled = false;
                this.elements.resetBtn.disabled = false;
                this.elements.messageInput.disabled = false;
                this.elements.sendButton.disabled = false;
                this.elements.refreshMemoryBtn.disabled = false;
                this.elements.assembleContextBtn.disabled = false;
            }

            enableEdit() {
                this.isEditing = true;
                
                this.elements.systemPrompt.disabled = false;
                this.elements.modulePrompt.disabled = false;
                this.elements.memoryRules.disabled = false;
                this.elements.moduleCorpus.disabled = false;
                
                this.elements.editBtn.style.display = 'none';
                this.elements.saveBtn.style.display = 'inline-block';
                this.elements.cancelBtn.style.display = 'inline-block';
                this.elements.saveBtn.disabled = false;
                this.elements.cancelBtn.disabled = false;
                
                this.updateStatus('Enhanced editing enabled - make changes and save');
            }

            async saveConfig() {
                const config = {
                    system_prompt: this.elements.systemPrompt.value,
                    module_prompt: this.elements.modulePrompt.value,
                    system_corpus: this.elements.memoryRules.value,
                    module_corpus: this.elements.moduleCorpus.value
                };

                try {
                    const response = await fetch(`${this.baseURL}/modules/${this.currentModule}/config`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });

                    if (response.ok) {
                        this.cancelEdit();
                        this.updateStatus('Enhanced configuration saved successfully');
                        await this.loadModules();
                    } else {
                        this.updateStatus('Failed to save configuration', true);
                    }
                } catch (error) {
                    this.updateStatus('Error saving configuration', true);
                }
            }

            cancelEdit() {
                this.isEditing = false;
                
                this.elements.systemPrompt.disabled = true;
                this.elements.modulePrompt.disabled = true;
                this.elements.memoryRules.disabled = true;
                this.elements.moduleCorpus.disabled = true;
                
                this.elements.editBtn.style.display = 'inline-block';
                this.elements.saveBtn.style.display = 'none';
                this.elements.cancelBtn.style.display = 'none';
                
                if (this.currentModule) {
                    this.loadModuleConfig(this.currentModule);
                }
                
                this.updateStatus('Edit cancelled');
            }

            resetConfig() {
                if (confirm('Reset module configuration to default? This cannot be undone.')) {
                    this.clearConfigFields();
                    this.updateStatus('Configuration reset to default');
                }
            }

            resetChat() {
                this.messages = [];
                this.conversationId = null;
                
                const moduleName = this.elements.chatHeader.querySelector('h2').textContent.replace('Chat: ', '');
                this.elements.messages.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-icon">🌱</div>
                        <h3>Exploring: ${moduleName}</h3>
                        <p>Ready to explore communication theory through Socratic questioning. What aspects of ${moduleName.toLowerCase()} would you like to discover?</p>
                    </div>
                `;
            }

            async sendMessage(e) {
                e.preventDefault();
                
                const message = this.elements.messageInput.value.trim();
                if (!message || !this.currentModule) return;

                this.currentMessage = message;
                this.addMessage('user', message);
                this.elements.messageInput.value = '';
                this.autoResize();
                this.showTyping();

                try {
                    // Try enhanced chat first
                    let response = await fetch(`${this.baseURL}/chat/enhanced`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            module_id: this.currentModule,
                            conversation_id: this.conversationId,
                            user_id: 1
                        })
                    });

                    if (!response.ok) {
                        // Fallback to regular chat
                        response = await fetch(`${this.baseURL}/chat/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: message,
                                module_id: this.currentModule,
                                conversation_id: this.conversationId,
                                user_id: 1
                            })
                        });
                    }

                    const data = await response.json();
                    
                    if (!this.conversationId && data.conversation_id) {
                        this.conversationId = data.conversation_id;
                    }

                    this.hideTyping();
                    this.addMessage('assistant', data.reply || 'I apologize, but I encountered an error.');
                    
                    if (data.memory_metrics) {
                        this.updateStatus(`Enhanced response • Memory: ${data.memory_metrics.total_chars} chars • Score: ${Math.round(data.memory_metrics.optimization_score)}/100`);
                    } else {
                        this.updateStatus('Response received (standard memory)');
                    }

                    // Auto-refresh memory tab if it's active
                    if (this.currentTab === 'memory') {
                        setTimeout(() => this.loadEnhancedMemoryMetrics(), 1000);
                    }

                } catch (error) {
                    console.error('Chat error:', error);
                    this.hideTyping();
                    this.addMessage('assistant', 'I apologize, but I encountered an error. Please try again.');
                    this.updateStatus('Chat error occurred', true);
                }
            }

            addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const avatar = role === 'user' ? 'You' : '🌱';
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div>
                        <div class="message-content">${content}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;

                const welcome = this.elements.messages.querySelector('.welcome-message');
                if (welcome) welcome.remove();

                this.elements.messages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message assistant typing';
                typingDiv.innerHTML = `
                    <div class="message-avatar">🌱</div>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                this.elements.messages.appendChild(typingDiv);
                this.scrollToBottom();
            }

            hideTyping() {
                const typing = this.elements.messages.querySelector('.typing');
                if (typing) typing.remove();
            }

            scrollToBottom() {
                this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
            }

            autoResize() {
                const textarea = this.elements.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            async loadEnhancedMemoryMetrics() {
                if (!this.currentModule) {
                    this.elements.memoryContent.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 16px;">🧠</div>
                            <h3>Enhanced Memory System</h3>
                            <p>Select a module to view enhanced memory layers with real-time metrics.</p>
                        </div>
                    `;
                    return;
                }

                try {
                    // Try enhanced memory endpoint first
                    let response = await fetch(`${this.baseURL}/memory/enhanced/${this.currentModule}?user_id=1`);
                    
                    if (response.ok) {
                        const memoryData = await response.json();
                        this.displayEnhancedMemory(memoryData);
                        this.updateStatus('Enhanced memory metrics loaded successfully');
                    } else {
                        // Fallback to basic memory display
                        this.displayBasicMemory();
                        this.updateStatus('Using basic memory system (enhanced not available)');
                    }
                } catch (error) {
                    console.error('Enhanced memory error:', error);
                    this.displayBasicMemory();
                    this.updateStatus('Error loading enhanced memory - using fallback');
                }
            }

            displayEnhancedMemory(memoryData) {
                this.elements.memoryContent.innerHTML = `
                    <div class="enhanced-memory-display">
                        <!-- Dynamic Memory Metrics -->
                        <div class="memory-metrics-card">
                            <h3>🧠 Enhanced Dynamic Memory Metrics</h3>
                            <div class="metrics-grid">
                                <div class="metric">
                                    <label>Context Length</label>
                                    <span class="value">${memoryData.context_metrics?.total_chars || 0}</span>
                                </div>
                                <div class="metric">
                                    <label>Optimization Score</label>
                                    <span class="value">${Math.round(memoryData.context_metrics?.optimization_score || 0)}/100</span>
                                </div>
                                <div class="metric">
                                    <label>Memory Layers</label>
                                    <span class="value">4 Active</span>
                                </div>
                            </div>
                            <div class="memory-distribution">
                                <div class="layer system" style="width: ${memoryData.context_metrics?.system_weight || 25}%">
                                    System (${memoryData.context_metrics?.system_weight || 25}%)
                                </div>
                                <div class="layer module" style="width: ${memoryData.context_metrics?.module_weight || 35}%">
                                    Module (${memoryData.context_metrics?.module_weight || 35}%)
                                </div>
                                <div class="layer conversation" style="width: ${memoryData.context_metrics?.conversation_weight || 25}%">
                                    Conversation (${memoryData.context_metrics?.conversation_weight || 25}%)
                                </div>
                                <div class="layer prior" style="width: ${memoryData.context_metrics?.prior_weight || 15}%">
                                    Prior (${memoryData.context_metrics?.prior_weight || 15}%)
                                </div>
                            </div>
                        </div>

                        <!-- Memory Layers -->
                        <div class="memory-section">
                            <h3>📊 Enhanced Memory Layers</h3>
                            <div class="memory-details">
                                <div class="memory-layer">
                                    <h4>🔵 System Data Layer</h4>
                                    <div class="layer-content">
                                        <p><strong>Learning Profile:</strong> ${memoryData.memory_layers?.system_data?.learning_profile?.style || 'Adaptive'} learner, ${memoryData.memory_layers?.system_data?.learning_profile?.pace || 'moderate'} pace</p>
                                        <p><strong>Prior Modules:</strong> ${memoryData.memory_layers?.system_data?.cross_module_mastery?.length || 0} previous interactions</p>
                                        <p><strong>Background:</strong> ${memoryData.memory_layers?.system_data?.learning_profile?.background || 'Beginner'}</p>
                                    </div>
                                </div>

                                <div class="memory-layer">
                                    <h4>🟢 Module Data Layer</h4>
                                    <div class="layer-content">
                                        <p><strong>Current Module:</strong> ${memoryData.memory_layers?.module_data?.module_info?.title || 'Module ' + (this.currentModule || 1)}</p>
                                        <p><strong>Teaching Strategy:</strong> ${memoryData.memory_layers?.module_data?.socratic_strategy || 'Socratic questioning'}</p>
                                        <p><strong>System Prompt:</strong> ${memoryData.memory_layers?.module_data?.teaching_configuration?.system_prompt ? 'Custom configured' : 'Default settings'}</p>
                                        <p><strong>Module Prompt:</strong> ${memoryData.memory_layers?.module_data?.teaching_configuration?.module_prompt ? 'Enhanced active' : 'Basic'}</p>
                                    </div>
                                </div>

                                <div class="memory-layer">
                                    <h4>🟡 Conversation Data Layer</h4>
                                    <div class="layer-content">
                                        <p><strong>State:</strong> ${memoryData.memory_layers?.conversation_data?.state || 'Ready'}</p>
                                        <p><strong>Message History:</strong> ${memoryData.memory_layers?.conversation_data?.message_history?.length || 0} exchanges</p>
                                        <p><strong>Engagement:</strong> ${memoryData.memory_layers?.conversation_data?.conversation_analysis?.engagement_level || 'Starting'}</p>
                                        <p><strong>Context:</strong> ${memoryData.memory_layers?.conversation_data?.dialogue_context || 'Ready to begin Socratic exploration'}</p>
                                    </div>
                                </div>

                                <div class="memory-layer">
                                    <h4>🔴 Prior Knowledge Layer</h4>
                                    <div class="layer-content">
                                        <p><strong>Prior Module Insights:</strong> ${memoryData.memory_layers?.prior_knowledge?.prior_module_insights?.length || 0} connections</p>
                                        <p><strong>Mastered Concepts:</strong> ${memoryData.memory_layers?.prior_knowledge?.mastered_concepts?.join(', ') || 'Building foundation'}</p>
                                        ${memoryData.memory_layers?.prior_knowledge?.prior_module_insights?.slice(0, 2).map(insight => 
                                            `<p><strong>${insight.module_title}:</strong> ${insight.key_insight}</p>`
                                        ).join('') || ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Database Status -->
                        <div class="memory-section">
                            <h3>🔄 Live Database Status</h3>
                            <div class="memory-details">
                                <div class="status-grid">
                                    <div class="status-item">
                                        <span class="indicator ${memoryData.database_status?.onboarding ? 'active' : 'inactive'}"></span>
                                        <label>Onboarding Survey Data</label>
                                    </div>
                                    <div class="status-item">
                                        <span class="indicator ${memoryData.database_status?.module_config ? 'active' : 'inactive'}"></span>
                                        <label>Module Configuration</label>
                                    </div>
                                    <div class="status-item">
                                        <span class="indicator ${memoryData.database_status?.conversation_analysis ? 'active' : 'inactive'}"></span>
                                        <label>Conversation Analysis</label>
                                    </div>
                                    <div class="status-item">
                                        <span class="indicator ${memoryData.database_status?.cross_module ? 'active' : 'inactive'}"></span>
                                        <label>Cross-Module Connections</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assembled Prompt Preview -->
                        <div class="prompt-preview-card">
                            <h3>🔍 Assembled Memory Context (Sent to AI)</h3>
                            <div class="prompt-content">
                                <pre>${memoryData.assembled_prompt || 'No prompt data available'}</pre>
                                <button onclick="harv.showFullPrompt('${(memoryData.assembled_prompt || '').replace(/'/g, '\\\'').replace(/"/g, '\\"')}')">View Full Context</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            displayBasicMemory() {
                this.elements.memoryContent.innerHTML = `
                    <div class="memory-section">
                        <h3>🧠 Basic Memory System</h3>
                        <div class="memory-details">
                            <p><strong>Status:</strong> Enhanced memory system not available</p>
                            <p><strong>Module:</strong> ${this.currentModule ? 'Module ' + this.currentModule : 'No module selected'}</p>
                            <p><strong>Configuration:</strong> ${this.elements.systemPrompt.value ? 'Custom prompts configured' : 'Default settings'}</p>
                            <p><strong>Note:</strong> Install enhanced memory system to see dynamic memory layers</p>
                        </div>
                    </div>
                `;
            }

            showFullPrompt(prompt) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
                    align-items: center; justify-content: center; padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 8px; max-width: 90%; max-height: 90%; overflow: auto; padding: 20px;">
                        <h3 style="margin-bottom: 15px;">Complete Assembled Memory Context</h3>
                        <pre style="white-space: pre-wrap; font-size: 12px; line-height: 1.4; background: #f8f9fa; padding: 15px; border-radius: 4px;">${prompt}</pre>
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 15px; padding: 8px 16px; background: #3E5641; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            updateStatus(message, isError = false) {
                this.elements.statusMessage.textContent = message;
                this.elements.statusMessage.style.color = isError ? '#dc3545' : '#6c757d';
            }
        }

        const harv = new HarvEnhancedInterface();
    </script>
</body>
</html>
