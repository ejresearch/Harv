<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primer Initiative - GPT Tutor Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">PRIMER INITIATIVE - GPT TUTOR CONFIGURATION</h1>
            <p class="text-gray-600">Configure and test Socratic GPT tutors for the 15 Mass Communication modules</p>
        </div>

        <!-- Status Container -->
        <div id="statusContainer"></div>

        <!-- Module Selector -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex-1 min-w-48">
                    <label for="moduleSelector" class="block font-semibold mb-2 text-gray-700">Module</label>
                    <select id="moduleSelector" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Loading modules...</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-6">
                    <button id="editBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Edit</button>
                    <button id="saveBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Save</button>
                    <button id="cancelBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Cancel</button>
                </div>
            </div>
        </div>

        <!-- Configuration Fields -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Module Configuration</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="mb-4">
                    <label for="systemPrompt" class="block font-semibold mb-2 text-gray-700">Socratic System Prompt</label>
                    <textarea id="systemPrompt" rows="6" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled placeholder="Define the overall Socratic tutoring approach..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="modulePrompt" class="block font-semibold mb-2 text-gray-700">Module-Specific Prompt</label>
                    <textarea id="modulePrompt" rows="6" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled placeholder="Define module-specific Socratic approach..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="systemCorpus" class="block font-semibold mb-2 text-gray-700">Course Knowledge Base</label>
                    <textarea id="systemCorpus" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled placeholder="Enter course-wide knowledge..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="moduleCorpus" class="block font-semibold mb-2 text-gray-700">Module Resources</label>
                    <textarea id="moduleCorpus" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled placeholder="Enter module-specific resources..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="dynamicCorpus" class="block font-semibold mb-2 text-gray-700">Current Events</label>
                    <textarea id="dynamicCorpus" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled placeholder="Enter current events and examples..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="apiEndpoint" class="block font-semibold mb-2 text-gray-700">API Endpoint</label>
                    <input type="text" id="apiEndpoint" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled placeholder="https://api.openai.com/v1/chat/completions">
                </div>
            </div>
        </div>

        <!-- Test Chat -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Test Socratic Tutoring</h2>
            
            <div class="mb-4">
                <div class="flex gap-2">
                    <input type="text" id="chatInput" class="flex-1 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled placeholder="Enter test message...">
                    <button id="sendBtn" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Send</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block font-semibold mb-2 text-gray-700">GPT Response</label>
                <div id="chatHistory" class="p-4 border border-gray-200 rounded-md bg-gray-50 min-h-32 max-h-64 overflow-y-auto">
                    <div class="text-gray-500 italic">Select a module to start testing...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class HarvDevGUI {
            constructor() {
                this.baseURL = 'http://127.0.0.1:8000';
                this.currentModule = null;
                this.isEditing = false;
                this.testUserId = 1;
                
                this.initializeElements();
                this.attachEventListeners();
                this.loadModules();
            }

            initializeElements() {
                this.elements = {
                    moduleSelector: document.getElementById('moduleSelector'),
                    editBtn: document.getElementById('editBtn'),
                    saveBtn: document.getElementById('saveBtn'),
                    cancelBtn: document.getElementById('cancelBtn'),
                    systemPrompt: document.getElementById('systemPrompt'),
                    modulePrompt: document.getElementById('modulePrompt'),
                    systemCorpus: document.getElementById('systemCorpus'),
                    moduleCorpus: document.getElementById('moduleCorpus'),
                    dynamicCorpus: document.getElementById('dynamicCorpus'),
                    apiEndpoint: document.getElementById('apiEndpoint'),
                    chatInput: document.getElementById('chatInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    chatHistory: document.getElementById('chatHistory'),
                    statusContainer: document.getElementById('statusContainer')
                };
            }

            attachEventListeners() {
                this.elements.moduleSelector.addEventListener('change', () => this.onModuleChange());
                this.elements.editBtn.addEventListener('click', () => this.enableEditing());
                this.elements.saveBtn.addEventListener('click', () => this.saveConfiguration());
                this.elements.cancelBtn.addEventListener('click', () => this.cancelEditing());
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            showStatus(message, type = 'success') {
                const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
                const icon = type === 'success' ? '✅' : '❌';
                
                this.elements.statusContainer.innerHTML = `
                    <div class="${bgColor} border px-4 py-3 rounded mb-4">
                        ${icon} ${message}
                    </div>
                `;
                
                setTimeout(() => {
                    this.elements.statusContainer.innerHTML = '';
                }, 5000);
            }

            async loadModules() {
                try {
                    console.log('Loading modules from:', this.baseURL);
                    const response = await fetch(`${this.baseURL}/modules`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const modules = await response.json();
                    console.log('Modules loaded:', modules);
                    
                    this.elements.moduleSelector.innerHTML = '<option value="">Select a module...</option>';
                    
                    modules.forEach(module => {
                        const option = document.createElement('option');
                        option.value = module.id;
                        option.textContent = `Module ${module.id}: ${module.title}`;
                        this.elements.moduleSelector.appendChild(option);
                    });
                    
                    this.showStatus(`Successfully loaded ${modules.length} modules!`);
                } catch (error) {
                    console.error('Error loading modules:', error);
                    this.showStatus(`Failed to connect to backend: ${error.message}`, 'error');
                }
            }

            async onModuleChange() {
                const moduleId = this.elements.moduleSelector.value;
                if (!moduleId) {
                    this.clearFields();
                    this.updateButtonStates();
                    return;
                }

                this.currentModule = moduleId;
                await this.loadModuleConfiguration(moduleId);
                this.updateButtonStates();
            }

            async loadModuleConfiguration(moduleId) {
                try {
                    const response = await fetch(`${this.baseURL}/modules/${moduleId}`);
                    if (response.ok) {
                        const config = await response.json();
                        this.setFieldValues(config);
                        this.showStatus(`Loaded configuration for ${config.title}`);
                    } else {
                        this.setFieldValues({});
                        this.showStatus(`Module ${moduleId} is empty. Click Edit to add configuration.`);
                    }
                } catch (error) {
                    this.setFieldValues({});
                    this.showStatus('Error loading module configuration', 'error');
                }
            }

            setFieldValues(config) {
                this.elements.systemPrompt.value = config.system_prompt || '';
                this.elements.modulePrompt.value = config.module_prompt || '';
                this.elements.systemCorpus.value = config.system_corpus || '';
                this.elements.moduleCorpus.value = config.module_corpus || '';
                this.elements.dynamicCorpus.value = config.dynamic_corpus || '';
                this.elements.apiEndpoint.value = config.api_endpoint || 'https://api.openai.com/v1/chat/completions';
            }

            clearFields() {
                this.setFieldValues({});
            }

            enableEditing() {
                this.isEditing = true;
                const fields = [this.elements.systemPrompt, this.elements.modulePrompt, 
                               this.elements.systemCorpus, this.elements.moduleCorpus, 
                               this.elements.dynamicCorpus, this.elements.apiEndpoint];
                fields.forEach(field => field.disabled = false);
                this.updateButtonStates();
                this.showStatus('Editing enabled. Make changes and click Save.');
            }

            async saveConfiguration() {
                const config = {
                    system_prompt: this.elements.systemPrompt.value,
                    module_prompt: this.elements.modulePrompt.value,
                    system_corpus: this.elements.systemCorpus.value,
                    module_corpus: this.elements.moduleCorpus.value,
                    dynamic_corpus: this.elements.dynamicCorpus.value,
                    api_endpoint: this.elements.apiEndpoint.value
                };

                try {
                    const response = await fetch(`${this.baseURL}/modules/${this.currentModule}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });

                    if (response.ok) {
                        this.showStatus(`Configuration saved for Module ${this.currentModule}!`);
                    } else {
                        throw new Error('Save failed');
                    }
                } catch (error) {
                    this.showStatus('Failed to save configuration', 'error');
                }

                this.isEditing = false;
                this.disableEditing();
            }

            cancelEditing() {
                this.isEditing = false;
                this.disableEditing();
                this.loadModuleConfiguration(this.currentModule);
                this.showStatus('Changes cancelled');
            }

            disableEditing() {
                const fields = [this.elements.systemPrompt, this.elements.modulePrompt, 
                               this.elements.systemCorpus, this.elements.moduleCorpus, 
                               this.elements.dynamicCorpus, this.elements.apiEndpoint];
                fields.forEach(field => field.disabled = true);
                this.updateButtonStates();
            }

            updateButtonStates() {
                const hasModule = !!this.currentModule;
                this.elements.editBtn.disabled = !hasModule || this.isEditing;
                this.elements.saveBtn.disabled = !hasModule || !this.isEditing;
                this.elements.cancelBtn.disabled = !hasModule || !this.isEditing;
                this.elements.chatInput.disabled = !hasModule;
                this.elements.sendBtn.disabled = !hasModule;
            }

            async sendMessage() {
                const message = this.elements.chatInput.value.trim();
                if (!message) return;

                this.addChatMessage('You', message);
                this.elements.chatInput.value = '';

                try {
                    const response = await fetch(`${this.baseURL}/chat/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: this.testUserId,
                            module_id: parseInt(this.currentModule),
                            message: message
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.addChatMessage('GPT', result.reply);
                    } else {
                        throw new Error('Chat failed');
                    }
                } catch (error) {
                    this.addChatMessage('Error', 'Could not get response. Check OpenAI API key.');
                }
            }

            addChatMessage(sender, message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'mb-2 p-2 rounded';
                messageDiv.style.backgroundColor = sender === 'You' ? '#dbeafe' : '#f3f4f6';
                messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
                
                this.elements.chatHistory.appendChild(messageDiv);
                this.elements.chatHistory.scrollTop = this.elements.chatHistory.scrollHeight;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new HarvDevGUI();
        });
    </script>
</body>
</html>
